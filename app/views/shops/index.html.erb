<div class="shops-container">
  <h1 class="page-title">ショップ検索</h1>
  
  <!-- 検索フォーム -->
  <%= form_with url: shops_path, method: :get, local: true, class: "search-form" do |form| %>
    <div class="search-input-group">
      <%= form.text_field :search, placeholder: "キーワードを入力", value: params[:search], class: "search-input" %>
      <%= form.submit "検索", class: "search-button" %>
    </div>
  <% end %>
  
  <% if @has_searched %>
    <!-- 検索実行後の表示 -->
    <% if @shops.present? %>
      <!-- API検索結果の表示 -->
      <% if @shops.is_a?(Hash) %>
        <% if @shops['status'] == 'OK' && @shops['results'].present? %>
        <div class="api-results">
          <h2>検索結果 (<%= @shops['total_results'] %>件中 <%= (@shops['current_page'] - 1) * @shops['per_page'] + 1 %>-<%= [(@shops['current_page'] - 1) * @shops['per_page'] + @shops['results'].length, @shops['total_results']].min %>件)</h2>
          <div class="api-shops-list">
            <% @shops['results'].each_with_index do |place, index| %>
              <div class="api-shop-item">
                <div class="shop-info">
                  <h3 class="shop-name">
                    <%= link_to place['name'], shop_path(id: "api_#{index}", place_id: place['place_id'], name: place['name'], rating: place['rating'], address: place['formatted_address'], price_level: place['price_level'], user_ratings_total: place['user_ratings_total'], search: params[:search]), 
                        class: "shop-name-link" %>
                  </h3>
                  <% if place['rating'] %>
                    <div class="shop-rating">
                      <span class="stars">★</span>
                      <span class="rating-value"><%= place['rating'] %></span>
                      <% if place['user_ratings_total'] %>
                        <span class="rating-count">(<%= place['user_ratings_total'] %>件)</span>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
        
        <!-- ページネーション（一番下に表示） -->
        <% if @shops['total_pages'] > 1 %>
          <div class="pagination-container">
            <div class="pagination-info">
              <span>ページ <%= @shops['current_page'] %> / <%= @shops['total_pages'] %></span>
            </div>
            <div class="pagination-links">
              <% if @shops['has_prev_page'] %>
                <%= link_to shops_path(search: params[:search], page: @shops['current_page'] - 1), 
                    class: "pagination-link prev-link", title: "前の20件を表示" do %>
                  <span class="arrow-icon">⬅️</span>
                  <span>前へ</span>
                <% end %>
              <% end %>
              
              <% pages_to_show = [1, 2, 3].select { |n| n <= @shops['total_pages'] } %>
              <% pages_to_show.each do |page_num| %>
                <% if page_num == @shops['current_page'] %>
                  <span class="pagination-link current" title="現在のページ"><%= page_num %></span>
                <% else %>
                  <%= link_to shops_path(search: params[:search], page: page_num), 
                      class: "pagination-link", title: "#{page_num}ページ目を表示" do %>
                    <span><%= page_num %></span>
                  <% end %>
                <% end %>
              <% end %>
              
              <% if @shops['has_next_page'] %>
                <%= link_to shops_path(search: params[:search], page: @shops['current_page'] + 1), 
                    class: "pagination-link next-link", title: "次の20件を表示" do %>
                  <span>次へ</span>
                  <span class="arrow-icon">➡️</span>
                <% end %>
              <% end %>
            </div>
            
            <!-- 下向き矢印のナビゲーション -->
          </div>
        <% end %>
        <% elsif @shops['status'] == 'ZERO_RESULTS' %>
          <div class="no-results">
            <div class="no-results-icon">🔍</div>
            <h2>検索結果が見つかりませんでした</h2>
            <p>キーワードを変更して再度検索してください。</p>
          </div>
        <% elsif @shops['status'] == 'OVER_QUERY_LIMIT' %>
          <div class="api-error">
            <div class="error-icon">⚠️</div>
            <h2>API制限に達しました</h2>
            <p>しばらく時間をおいてから再度お試しください。</p>
          </div>
        <% elsif @shops['status'] == 'REQUEST_DENIED' %>
          <div class="api-error">
            <div class="error-icon">❌</div>
            <h2>APIアクセスが拒否されました</h2>
            <p>APIキーの設定を確認してください。</p>
          </div>
        <% else %>
          <div class="api-error">
            <div class="error-icon">❌</div>
            <h2>エラーが発生しました</h2>
            <p>ステータス: <%= @shops['status'] %></p>
            <% if @shops['error_message'] %>
              <p>エラーメッセージ: <%= @shops['error_message'] %></p>
            <% end %>
          </div>
        <% end %>
      <% elsif @shops.is_a?(Array) && @shops.any? %>
        <!-- データベースのショップ表示 -->
      <div class="shops-grid">
        <% @shops.each do |shop| %>
          <div class="shop-card">
            <div class="shop-header">
              <% if shop.profile_image.attached? %>
                <div class="shop-image">
                  <%= image_tag shop.profile_image, alt: shop.name, class: "profile-image" %>
                </div>
              <% end %>
              <h3 class="shop-name"><%= shop.name %></h3>
            </div>
            <div class="shop-body">
              <p class="shop-email">
                <i class="email-icon">📧</i>
                <%= shop.email %>
              </p>
              <div class="shop-actions">
                <%= link_to "詳細を見る", shop_path(shop), class: "btn btn-primary" %>
              </div>
            </div>
          </div>
        <% end %>
        </div>
        
        <div class="shops-count">
          <p>全<%= @shops.count %>件のショップが見つかりました</p>
        </div>
      <% end %>
    <% elsif @shops.nil? %>
      <div class="api-error">
        <div class="error-icon">❌</div>
        <h2>APIエラーが発生しました</h2>
        <p>サーバーエラーまたはネットワークエラーが発生しました。しばらく時間をおいてから再度お試しください。</p>
      </div>
    <% else %>
      <div class="no-results">
        <div class="no-results-icon">🔍</div>
        <h2>検索結果が見つかりませんでした</h2>
        <p>キーワードを変更して再度検索してください。</p>
      </div>
    <% end %>
  <% else %>
    <!-- ようこそ画面（検索前の初期状態） -->
    <div class="welcome-section">
      <div class="welcome-content">
        <div class="welcome-icon">✨</div>
        <h2>エステサロン検索へようこそ</h2>
        <p class="welcome-description">
          お気に入りのエステサロンを見つけましょう。<br>
          キーワードを入力して検索を開始してください。
        </p>
        <div class="welcome-features">
          <div class="feature-item">
            <div class="feature-icon">🔍</div>
            <h3>簡単検索</h3>
            <p>キーワードでお好みのサロンを検索</p>
          </div>
          <div class="feature-item">
            <div class="feature-icon">⭐</div>
            <h3>評価確認</h3>
            <p>口コミと評価でサロンを比較</p>
          </div>
          <div class="feature-item">
            <div class="feature-icon">📍</div>
            <h3>詳細情報</h3>
            <p>住所、営業時間、料金を確認</p>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>