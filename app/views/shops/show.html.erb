<% if @is_api_data || @shop.present? %>
  <div class="shop-detail-container">
    <% if @is_api_data %>
      <!-- APIデータの表示 -->
      <h1 class="shop-detail-title"><%= @shop_name %></h1>
      
      <% if @shop_rating %>
        <div class="shop-rating google-places-rating">
          <div class="rating-header">
            <h3>Google Places 評価</h3>
          </div>
          <div class="rating-display">
            <div class="stars-display">
              <% rating_value = @shop_rating.to_f %>
              <% 5.times do |i| %>
                <% if i < rating_value.floor %>
                  <span class="star filled">★</span>
                <% elsif i < rating_value %>
                  <span class="star half">★</span>
                <% else %>
                  <span class="star empty">☆</span>
                <% end %>
              <% end %>
            </div>
            <div class="rating-details">
              <span class="rating-value"><%= @shop_rating %></span>
              <span class="rating-max">/ 5.0</span>
              <% if @user_ratings_total %>
                <span class="rating-count">(<%= @user_ratings_total %>件のレビュー)</span>
              <% end %>
            </div>
          </div>
          <div class="rating-source">
            <small>データ提供: Google Places API</small>
          </div>
        </div>
      <% end %>
      
      <div class="shop-detail-info">
        <div class="info-item">
          <strong>ショップ名:</strong>
          <%= @shop_name %>
        </div>
        
        <div class="info-item">
          <strong>住所:</strong>
          <i class="location-icon">📍</i>
          <%= @shop_address %>
        </div>
        
        <% if @phone_number %>
          <div class="info-item">
            <strong>電話番号:</strong>
            <i class="phone-icon">📞</i>
            <a href="tel:<%= @phone_number %>" class="phone-link"><%= @phone_number %></a>
          </div>
        <% end %>
        
        <% if @shop_price_level %>
          <div class="info-item">
            <strong>価格帯:</strong>
            <i class="price-icon">💰</i>
            <%= '¥' * @shop_price_level.to_i %>
          </div>
        <% end %>
        
        
      <% if @photos && @photos.any? %>
        <div class="shop-photos">
          <h2>フォトギャラリー</h2>
          <div class="photos-grid">
            <% @photos.first(12).each_with_index do |photo, index| %>
              <% ref = photo['photo_reference'] %>
              <% max_width = [photo['width'].to_i, 600].min %>
              <div class="photo-item" onclick="openPhotoModal(<%= index %>)">
                <img src="https://maps.googleapis.com/maps/api/place/photo?maxwidth=<%= max_width %>&photoreference=<%= ref %>&key=<%= ENV['GOOGLE_PLACES_API_KEY'] %>" alt="<%= @shop_name %> の写真" />
                <div class="photo-overlay">
                  <span class="photo-zoom-icon">🔍</span>
                </div>
              </div>
            <% end %>
          </div>
        </div>
        
        <!-- フォトモーダル -->
        <div id="photoModal" class="photo-modal">
          <div class="photo-modal-content">
            <span class="photo-modal-close" onclick="closePhotoModal()">&times;</span>
            <img id="modalPhoto" src="" alt="拡大写真" />
            <div class="photo-modal-nav">
              <button class="photo-nav-btn" id="prevBtn" onclick="changePhoto(-1)">❮</button>
              <span id="photoCounter" class="photo-counter"></span>
              <button class="photo-nav-btn" id="nextBtn" onclick="changePhoto(1)">❯</button>
            </div>
          </div>
        </div>
      <% end %>
      <div class="shop-actions" style="margin: 10px 0;">
        <% if user_signed_in? %>
          <% if current_user.external_likes.exists?(place_id: @place_id) %>
            <%= button_to "いいね解除", external_likes_path(place_id: @place_id), method: :delete, class: "btn btn-secondary" %>
          <% else %>
            <%= button_to "いいね", external_likes_path(place_id: @place_id, name: @shop_name, address: @shop_address, rating: @shop_rating, user_ratings_total: @user_ratings_total), method: :post, class: "btn btn-primary" %>
          <% end %>
        <% else %>
          <%= link_to "ログインしていいねする", new_user_session_path, class: "btn btn-primary" %>
        <% end %>
      </div>
    <% else %>
      <!-- データベースデータの表示 -->
      <% if @shop.profile_image.attached? %>
        <div class="shop-profile-image">
          <%= image_tag @shop.profile_image, alt: @shop.name, class: "shop-main-image" %>
        </div>
      <% end %>
      
      <h1 class="shop-detail-title"><%= @shop.name %></h1>
      
      <div class="shop-rating">
        <span class="rating-stars">★</span>
        <span class="rating-value"><%= @shop.average_rating %></span>
        <span class="rating-count">(<%= @shop.shop_comments.count %>件のレビュー)</span>
      </div>
      <div class="shop-actions" style="margin: 10px 0;">
        <% if user_signed_in? %>
          <% if current_user.liked_shops.exists?(@shop.id) %>
            <%= button_to "いいね解除", shop_like_path(@shop), method: :delete, class: "btn btn-secondary" %>
          <% else %>
            <%= button_to "いいね", shop_like_path(@shop), method: :post, class: "btn btn-primary" %>
          <% end %>
        <% else %>
          <%= link_to "ログインしていいねする", new_user_session_path, class: "btn btn-primary" %>
        <% end %>
      </div>
      
      <div class="shop-detail-info">
        <div class="info-item">
          <strong>ショップ名:</strong>
          <%= @shop.name %>
        </div>
        
        <div class="info-item">
          <strong>メールアドレス:</strong>
          <i class="email-icon">📧</i>
          <%= @shop.email %>
        </div>
      </div>
    <% end %>

    <% unless @is_api_data %>
      <div class="persons-section">
        <h2>スタッフ一覧</h2>
        <% if @shop.persons.any? %>
          <div class="persons-grid">
            <% @shop.persons.each do |person| %>
              <div class="person-card">
                <% if person.profile_image.attached? %>
                  <div class="person-image">
                    <%= image_tag person.profile_image, alt: person.name, class: "person-profile-image" %>
                  </div>
                <% end %>
                <h3><%= person.name %></h3>
                <p>年齢: <%= person.age %>歳</p>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="no-persons">スタッフが登録されていません。</p>
        <% end %>
      </div>
    <% end %>

    <!-- コメント投稿フォーム -->
    <% if user_signed_in? %>
      <div class="comment-form-section">
        <h2>レビューを投稿</h2>
        <% if @is_api_data %>
          <!-- APIデータ用のコメントフォーム -->
          <%= form_with url: external_comments_path, method: :post, local: true, class: "comment-form" do |f| %>
            <div class="form-group">
              <%= f.label :rating, "評価", class: "form-label" %>
              <%= f.select :rating, options_for_select((1..5).map{ |i| ["★" * i + " (#{i})", i] }), 
                  { prompt: "評価を選択してください" }, 
                  { class: "form-control rating-select", name: "comment[rating]" } %>
            </div>
            
            <div class="form-group">
              <%= f.label :content, "コメント", class: "form-label" %>
              <%= f.text_area :content, rows: 4, class: "form-control", 
                  placeholder: "ショップについてのコメントをお書きください（最大500文字）",
                  maxlength: 500, name: "comment[content]" %>
              <small class="character-count">0/500文字</small>
            </div>
            
            <!-- 隠しフィールドでAPIデータの情報を保持 -->
            <%= f.hidden_field :place_id, value: @place_id, name: "comment[place_id]" %>
            <%= f.hidden_field :shop_name, value: @shop_name, name: "comment[shop_name]" %>
            <%= f.hidden_field :shop_address, value: @shop_address, name: "comment[shop_address]" %>
            
            <div class="form-actions">
              <%= f.submit "投稿する", class: "btn btn-primary submit-review" %>
            </div>
          <% end %>
        <% else %>
          <!-- データベースデータ用のコメントフォーム -->
          <%= form_with model: [@shop, @shop_comment], local: true do |f| %>
            <% if @shop_comment&.errors&.any? %>
              <div class="error-messages">
                <h4><%= pluralize(@shop_comment.errors.count, "件のエラー") %>があります:</h4>
                <ul>
                  <% @shop_comment.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>
            
            <div class="form-group">
              <%= f.label :rating, "評価", class: "form-label" %>
              <%= f.select :rating, options_for_select((1..5).map{ |i| ["★" * i + " (#{i})", i] }), 
                  { prompt: "評価を選択してください" }, 
                  { class: "form-control rating-select" } %>
            </div>
            
            <div class="form-group">
              <%= f.label :content, "コメント", class: "form-label" %>
              <%= f.text_area :content, rows: 4, class: "form-control", 
                  placeholder: "ショップについてのコメントをお書きください（最大500文字）",
                  maxlength: 500 %>
              <small class="character-count">0/500文字</small>
            </div>
            
            <div class="form-actions">
              <%= f.submit "投稿する", class: "btn btn-primary submit-review" %>
            </div>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="login-prompt">
        <p>レビューを投稿するにはログインが必要です。</p>
        <%= link_to "ログイン", new_user_session_path, class: "btn btn-outline-primary" %>
      </div>
    <% end %>

    <!-- AI分析による評価まとめ -->
    <% if @is_api_data %>
      <div class="ai-analysis-section">
        <h2>🤖 AI分析による評価まとめ</h2>
        <div class="ai-analysis-content">
          <% if @ai_review_summary.present? %>
            <div class="ai-summary">
              <%= render_markdown(@ai_review_summary) %>
            </div>
            <div class="ai-source">
              <small>※ この分析はDeepSeek AIがGoogle Placesのレビューを基に自動生成したものです</small>
            </div>
          <% else %>
            <div class="ai-analyze-action">
              <button id="analyzeBtn" class="btn btn-primary" onclick="startAIAnalysis()">
                🤖 AI分析を実行
              </button>
              <div id="analyzeStatus" class="analyze-status" style="display: none;">
                分析中... しばらくお待ちください
              </div>
            </div>
            <div class="ai-hint">
              <p>💡 ボタンをクリックすると、Google Placesのレビューを基にAIが店舗の評価を分析します</p>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Hotpepper情報 -->
    
    
    <% if @hotpepper_shops && @hotpepper_shops.any? %>
      <div class="hotpepper-section">
        <h2>🍜 Hotpepper グルメ情報</h2>
        <% if @hotpepper_fallback_search %>
          <div class="hotpepper-fallback-notice">
            <small>※ 直接の店舗名では見つからなかったため、関連する店舗を表示しています</small>
          </div>
        <% end %>
        <div class="hotpepper-shops">
          <% @hotpepper_shops.first(3).each do |shop| %>
            <div class="hotpepper-shop-card">
              <div class="hotpepper-shop-header">
                <h3><%= shop['name'] %></h3>
                <% if shop['genre']['name'] %>
                  <span class="hotpepper-genre"><%= shop['genre']['name'] %></span>
                <% end %>
              </div>
              
              <div class="hotpepper-shop-info">
                <% if shop['catch'] %>
                  <p class="hotpepper-catch"><%= shop['catch'] %></p>
                <% end %>
                
                <% if shop['address'] %>
                  <div class="hotpepper-address">
                    <strong>住所:</strong> <%= shop['address'] %>
                  </div>
                <% end %>
                
                <% if shop['open'] %>
                  <div class="hotpepper-hours">
                    <strong>営業時間:</strong> <%= shop['open'] %>
                  </div>
                <% end %>
                
                
                
                <% if shop['access'] %>
                  <div class="hotpepper-access">
                    <strong>アクセス:</strong> <%= shop['access'] %>
                  </div>
                <% end %>
              </div>
              
              <div class="hotpepper-shop-actions">
                <% if shop['urls']['pc'] %>
                  <a href="<%= shop['urls']['pc'] %>" target="_blank" class="btn btn-hotpepper">
                    Hotpepperで詳細を見る
                  </a>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
        
        <div class="hotpepper-source">
          <small>データ提供: <a href="https://webservice.recruit.co.jp/" target="_blank">ホットペッパーグルメ Webサービス</a></small>
        </div>
      </div>
    <% elsif @hotpepper_shops.nil? %>
      <div class="hotpepper-section">
        <h2>🍜 Hotpepper グルメ情報</h2>
        <div class="hotpepper-error">
          <p>Hotpepperからの情報を取得できませんでした。</p>
          <small>APIキーの設定を確認してください。</small>
        </div>
      </div>
    <% elsif @hotpepper_shops.empty? %>
      <div class="hotpepper-section">
        <h2>🍜 Hotpepper グルメ情報</h2>
        <div class="hotpepper-no-results">
          <p>「<%= @shop_name || @shop&.name %>」に関する情報が見つかりませんでした。</p>
          <small>別のキーワードで検索してみてください。</small>
        </div>
      </div>
    <% end %>

    <!-- レビュー一覧 -->
    <div class="reviews-section">
      <h2>レビュー一覧</h2>
      
      <% if @is_api_data %>
        <!-- ユーザーコメント -->
        <% if @external_comments && @external_comments.any? %>
          <div class="user-comments">
            <h3>ユーザーレビュー</h3>
            <div class="comments-list">
              <% @external_comments.each do |comment| %>
                <div class="comment-item">
                  <div class="comment-header">
                    <div class="comment-user-info">
                      <span class="comment-user"><%= comment.user.name || "匿名ユーザー" %></span>
                      <span class="comment-rating">
                        <% comment.rating.times do %>★<% end %>
                        <span class="rating-number">(<%= comment.rating %>)</span>
                      </span>
                    </div>
                    <div class="comment-meta">
                      <span class="comment-date"><%= comment.created_at.strftime("%Y年%m月%d日") %></span>
                      <% if current_user == comment.user %>
                        <%= link_to "削除", external_comment_path(comment), method: :delete, 
                            confirm: "本当に削除しますか？", 
                            class: "comment-delete" %>
                      <% end %>
                    </div>
                  </div>
                  <div class="comment-content">
                    <%= simple_format(comment.content) %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
        
        <!-- Google Places レビュー -->
        <% if @place_reviews && @place_reviews.any? %>
          <div class="google-reviews">
            <h3>Google Places レビュー</h3>
            <div class="reviews-list">
              <% @place_reviews.each do |review| %>
                <div class="review-item google-review">
                  <div class="review-header">
                    <div class="review-user-info">
                      <span class="review-author">
                        <% if review['author_name'] %>
                          <%= review['author_name'] %>
                        <% else %>
                          匿名ユーザー
                        <% end %>
                      </span>
                      <div class="review-rating">
                        <% if review['rating'] %>
                          <% review['rating'].to_i.times do %>★<% end %>
                          <% (5 - review['rating'].to_i).times do %>☆<% end %>
                          <span class="rating-number">(<%= review['rating'] %>)</span>
                        <% end %>
                      </div>
                    </div>
                    <div class="review-meta">
                      <span class="review-date">
                        <% if review['time'] %>
                          <%= Time.at(review['time']).strftime("%Y年%m月%d日") %>
                        <% end %>
                      </span>
                    </div>
                  </div>
                  <div class="review-content">
                    <% if review['text'] %>
                      <p><%= review['text'] %></p>
                    <% else %>
                      <p class="no-text">レビューテキストはありません</p>
                    <% end %>
                  </div>
                  <% if review['author_url'] %>
                    <div class="review-source">
                      <small>Google Places で確認</small>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% elsif @external_comments.blank? %>
          <div class="no-reviews">
            <div class="no-reviews-icon">💬</div>
            <p>レビューはありません。</p>
          </div>
        <% end %>
      <% else %>
        <!-- データベースのコメント -->
        <% if @shop.shop_comments.any? %>
          <div class="comments-list">
            <% @shop.shop_comments.order(created_at: :desc).each do |comment| %>
              <div class="comment-item">
                <div class="comment-header">
                  <div class="comment-user-info">
                    <span class="comment-user"><%= comment.user.name || "匿名ユーザー" %></span>
                    <span class="comment-rating">
                      <% comment.rating.times do %>★<% end %>
                      <span class="rating-number">(<%= comment.rating %>)</span>
                    </span>
                  </div>
                  <div class="comment-meta">
                    <span class="comment-date"><%= comment.created_at.strftime("%Y年%m月%d日") %></span>
                    <% if current_user == comment.user %>
                      <%= link_to "削除", [@shop, comment], method: :delete, 
                          confirm: "本当に削除しますか？", 
                          class: "comment-delete" %>
                    <% end %>
                  </div>
                </div>
                <div class="comment-content">
                  <%= simple_format(comment.content) %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="no-comments">
            <div class="no-comments-icon">💬</div>
            <p>まだレビューがありません。</p>
            <p>最初のレビューを投稿してみませんか？</p>
          </div>
        <% end %>
      <% end %>
    </div>
    
    <div class="shop-actions">
      <% if @search_query.present? %>
        <%= link_to "一覧に戻る", shops_path(search: @search_query), class: "btn btn-secondary" %>
      <% else %>
        <%= link_to "一覧に戻る", shops_path, class: "btn btn-secondary" %>
      <% end %>
    </div>
  </div>
<% end %>

<script>
// フォトモーダル関連の変数
let currentPhotoIndex = 0;
let photos = [];

// ページ読み込み時に写真データを準備
document.addEventListener('DOMContentLoaded', function() {
  <% if @photos && @photos.any? %>
    photos = [
      <% @photos.first(12).each do |photo| %>
        {
          ref: '<%= photo['photo_reference'] %>',
          width: <%= photo['width'] || 800 %>,
          height: <%= photo['height'] || 600 %>
        },
      <% end %>
    ];
  <% end %>
});

function openPhotoModal(index) {
  currentPhotoIndex = index;
  const modal = document.getElementById('photoModal');
  const modalPhoto = document.getElementById('modalPhoto');
  const photoCounter = document.getElementById('photoCounter');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  
  if (photos.length === 0) return;
  
  // 写真を表示
  updateModalPhoto();
  
  // カウンターを更新
  photoCounter.textContent = `${currentPhotoIndex + 1} / ${photos.length}`;
  
  // ナビゲーションボタンの状態を更新
  prevBtn.disabled = currentPhotoIndex === 0;
  nextBtn.disabled = currentPhotoIndex === photos.length - 1;
  
  // モーダルを表示
  modal.style.display = 'block';
  document.body.style.overflow = 'hidden'; // スクロールを無効化
}

function closePhotoModal() {
  const modal = document.getElementById('photoModal');
  modal.style.display = 'none';
  document.body.style.overflow = ''; // スクロールを有効化
}

function changePhoto(direction) {
  const newIndex = currentPhotoIndex + direction;
  
  if (newIndex >= 0 && newIndex < photos.length) {
    currentPhotoIndex = newIndex;
    updateModalPhoto();
    
    // カウンターを更新
    const photoCounter = document.getElementById('photoCounter');
    photoCounter.textContent = `${currentPhotoIndex + 1} / ${photos.length}`;
    
    // ナビゲーションボタンの状態を更新
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    prevBtn.disabled = currentPhotoIndex === 0;
    nextBtn.disabled = currentPhotoIndex === photos.length - 1;
  }
}

function updateModalPhoto() {
  const modalPhoto = document.getElementById('modalPhoto');
  const photo = photos[currentPhotoIndex];
  
  if (photo) {
    // 高解像度の写真を取得（maxwidth=1200）
    const photoUrl = `https://maps.googleapis.com/maps/api/place/photo?maxwidth=1200&photoreference=${photo.ref}&key=<%= ENV['GOOGLE_PLACES_API_KEY'] %>`;
    modalPhoto.src = photoUrl;
    modalPhoto.alt = '<%= @shop_name %> の写真';
  }
}

// キーボードナビゲーション
document.addEventListener('keydown', function(e) {
  const modal = document.getElementById('photoModal');
  if (modal.style.display === 'block') {
    if (e.key === 'Escape') {
      closePhotoModal();
    } else if (e.key === 'ArrowLeft') {
      changePhoto(-1);
    } else if (e.key === 'ArrowRight') {
      changePhoto(1);
    }
  }
});

// モーダル外をクリックして閉じる
document.getElementById('photoModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closePhotoModal();
  }
});

function startAIAnalysis() {
  const button = document.getElementById('analyzeBtn');
  const status = document.getElementById('analyzeStatus');
  const aiContent = document.querySelector('.ai-analysis-content');
  
  // ボタンを無効化し、進行状況を表示
  button.disabled = true;
  button.textContent = '分析中...';
  status.style.display = 'block';
  
  // リクエストパラメータを準備
  const params = new URLSearchParams();
  params.append('place_id', '<%= @place_id %>');
  params.append('name', '<%= @shop_name %>');
  params.append('address', '<%= @shop_address %>');
  
  // AJAXでAI分析を実行
  fetch('<%= analyze_ai_shop_path(id: params[:id]) %>', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
    },
    body: params
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // 成功時：分析結果を表示（サーバー側でMarkdown→HTML変換済み）
      aiContent.innerHTML = `
        <div class="ai-summary">${data.summary_html}</div>
        <div class="ai-source">
          <small>※ この分析はDeepSeek AIがGoogle Placesのレビューを基に自動生成したものです</small>
        </div>
      `;
    } else {
      // エラー時：エラーメッセージを表示
      aiContent.innerHTML = `
        <div class="ai-error">
          <p>⚠️ AI分析に失敗しました</p>
          <p>${data.error}</p>
        </div>
      `;
    }
  })
  .catch(error => {
    // ネットワークエラー時
    aiContent.innerHTML = `
      <div class="ai-error">
        <p>⚠️ ネットワークエラーが発生しました</p>
        <p>しばらく時間をおいてから再度お試しください。</p>
      </div>
    `;
  })
  .finally(() => {
    // ボタンを元に戻す
    button.disabled = false;
    button.textContent = '🤖 AI分析を実行';
    status.style.display = 'none';
  });
}
</script>

