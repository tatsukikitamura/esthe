<% if @is_api_data || @shop.present? %>
  <div class="shop-detail-container">
    <% if @is_api_data %>
      <!-- API„Éá„Éº„Çø„ÅÆË°®Á§∫ -->
      <h1 class="shop-detail-title"><%= @shop_name %></h1>
      
      <% if @shop_rating %>
        <div class="shop-rating google-places-rating">
          <div class="rating-header">
            <h3>Google Places Ë©ï‰æ°</h3>
          </div>
          <div class="rating-display">
            <div class="stars-display">
              <% rating_value = @shop_rating.to_f %>
              <% 5.times do |i| %>
                <% if i < rating_value.floor %>
                  <span class="star filled">‚òÖ</span>
                <% elsif i < rating_value %>
                  <span class="star half">‚òÖ</span>
                <% else %>
                  <span class="star empty">‚òÜ</span>
                <% end %>
              <% end %>
            </div>
            <div class="rating-details">
              <span class="rating-value"><%= @shop_rating %></span>
              <span class="rating-max">/ 5.0</span>
              <% if @user_ratings_total %>
                <span class="rating-count">(<%= @user_ratings_total %>‰ª∂„ÅÆ„É¨„Éì„É•„Éº)</span>
              <% end %>
            </div>
          </div>
          <div class="rating-source">
            <small>„Éá„Éº„ÇøÊèê‰æõ: Google Places API</small>
          </div>
        </div>
      <% end %>
      
      <div class="shop-detail-info">
        <div class="info-item">
          <strong>„Ç∑„Éß„ÉÉ„ÉóÂêç:</strong>
          <%= @shop_name %>
        </div>
        
        <div class="info-item">
          <strong>‰ΩèÊâÄ:</strong>
          <i class="location-icon">üìç</i>
          <%= @shop_address %>
        </div>
        
        <% if @phone_number %>
          <div class="info-item">
            <strong>ÈõªË©±Áï™Âè∑:</strong>
            <i class="phone-icon">üìû</i>
            <a href="tel:<%= @phone_number %>" class="phone-link"><%= @phone_number %></a>
          </div>
        <% end %>
        
        <% if @shop_price_level %>
          <div class="info-item">
            <strong>‰æ°Ê†ºÂ∏Ø:</strong>
            <i class="price-icon">üí∞</i>
            <%= '¬•' * @shop_price_level.to_i %>
          </div>
        <% end %>
        
        
      <% if @photos && @photos.any? %>
        <div class="shop-photos">
          <h2>„Éï„Ç©„Éà„ÇÆ„É£„É©„É™„Éº</h2>
          <div class="photos-grid">
            <% @photos.first(12).each_with_index do |photo, index| %>
              <% ref = photo['photo_reference'] %>
              <% max_width = [photo['width'].to_i, 600].min %>
              <div class="photo-item" onclick="openPhotoModal(<%= index %>)">
                <img src="https://maps.googleapis.com/maps/api/place/photo?maxwidth=<%= max_width %>&photoreference=<%= ref %>&key=<%= ENV['GOOGLE_PLACES_API_KEY'] %>" alt="<%= @shop_name %> „ÅÆÂÜôÁúü" />
                <div class="photo-overlay">
                  <span class="photo-zoom-icon">üîç</span>
                </div>
              </div>
            <% end %>
          </div>
        </div>
        
        <!-- „Éï„Ç©„Éà„É¢„Éº„ÉÄ„É´ -->
        <div id="photoModal" class="photo-modal">
          <div class="photo-modal-content">
            <span class="photo-modal-close" onclick="closePhotoModal()">&times;</span>
            <img id="modalPhoto" src="" alt="Êã°Â§ßÂÜôÁúü" />
            <div class="photo-modal-nav">
              <button class="photo-nav-btn" id="prevBtn" onclick="changePhoto(-1)">‚ùÆ</button>
              <span id="photoCounter" class="photo-counter"></span>
              <button class="photo-nav-btn" id="nextBtn" onclick="changePhoto(1)">‚ùØ</button>
            </div>
          </div>
        </div>
      <% end %>
      <div class="shop-actions" style="margin: 10px 0;">
        <% if user_signed_in? %>
          <% if current_user.external_likes.exists?(place_id: @place_id) %>
            <%= button_to "„ÅÑ„ÅÑ„Å≠Ëß£Èô§", external_likes_path(place_id: @place_id), method: :delete, class: "btn btn-secondary" %>
          <% else %>
            <%= button_to "„ÅÑ„ÅÑ„Å≠", external_likes_path(place_id: @place_id, name: @shop_name, address: @shop_address, rating: @shop_rating, user_ratings_total: @user_ratings_total), method: :post, class: "btn btn-primary" %>
          <% end %>
        <% else %>
          <%= link_to "„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„ÅÑ„Å≠„Åô„Çã", new_user_session_path, class: "btn btn-primary" %>
        <% end %>
      </div>
    <% else %>
      <!-- „Éá„Éº„Çø„Éô„Éº„Çπ„Éá„Éº„Çø„ÅÆË°®Á§∫ -->
      <% if @shop.profile_image.attached? %>
        <div class="shop-profile-image">
          <%= image_tag @shop.profile_image, alt: @shop.name, class: "shop-main-image" %>
        </div>
      <% end %>
      
      <h1 class="shop-detail-title"><%= @shop.name %></h1>
      
      <div class="shop-rating">
        <span class="rating-stars">‚òÖ</span>
        <span class="rating-value"><%= @shop.average_rating %></span>
        <span class="rating-count">(<%= @shop.shop_comments.count %>‰ª∂„ÅÆ„É¨„Éì„É•„Éº)</span>
      </div>
      <div class="shop-actions" style="margin: 10px 0;">
        <% if user_signed_in? %>
          <% if current_user.liked_shops.exists?(@shop.id) %>
            <%= button_to "„ÅÑ„ÅÑ„Å≠Ëß£Èô§", shop_like_path(@shop), method: :delete, class: "btn btn-secondary" %>
          <% else %>
            <%= button_to "„ÅÑ„ÅÑ„Å≠", shop_like_path(@shop), method: :post, class: "btn btn-primary" %>
          <% end %>
        <% else %>
          <%= link_to "„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„ÅÑ„Å≠„Åô„Çã", new_user_session_path, class: "btn btn-primary" %>
        <% end %>
      </div>
      
      <div class="shop-detail-info">
        <div class="info-item">
          <strong>„Ç∑„Éß„ÉÉ„ÉóÂêç:</strong>
          <%= @shop.name %>
        </div>
        
        <div class="info-item">
          <strong>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ:</strong>
          <i class="email-icon">üìß</i>
          <%= @shop.email %>
        </div>
      </div>
    <% end %>

    <% unless @is_api_data %>
      <div class="persons-section">
        <h2>„Çπ„Çø„ÉÉ„Éï‰∏ÄË¶ß</h2>
        <% if @shop.persons.any? %>
          <div class="persons-grid">
            <% @shop.persons.each do |person| %>
              <div class="person-card">
                <% if person.profile_image.attached? %>
                  <div class="person-image">
                    <%= image_tag person.profile_image, alt: person.name, class: "person-profile-image" %>
                  </div>
                <% end %>
                <h3><%= person.name %></h3>
                <p>Âπ¥ÈΩ¢: <%= person.age %>Ê≠≥</p>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="no-persons">„Çπ„Çø„ÉÉ„Éï„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p>
        <% end %>
      </div>
    <% end %>

    <!-- „Ç≥„É°„É≥„ÉàÊäïÁ®ø„Éï„Ç©„Éº„É† -->
    <% if user_signed_in? %>
      <div class="comment-form-section">
        <h2>„É¨„Éì„É•„Éº„ÇíÊäïÁ®ø</h2>
        <% if @is_api_data %>
          <!-- API„Éá„Éº„ÇøÁî®„ÅÆ„Ç≥„É°„É≥„Éà„Éï„Ç©„Éº„É† -->
          <%= form_with url: external_comments_path, method: :post, local: true, class: "comment-form" do |f| %>
            <div class="form-group">
              <%= f.label :rating, "Ë©ï‰æ°", class: "form-label" %>
              <%= f.select :rating, options_for_select((1..5).map{ |i| ["‚òÖ" * i + " (#{i})", i] }), 
                  { prompt: "Ë©ï‰æ°„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ" }, 
                  { class: "form-control rating-select", name: "comment[rating]" } %>
            </div>
            
            <div class="form-group">
              <%= f.label :content, "„Ç≥„É°„É≥„Éà", class: "form-label" %>
              <%= f.text_area :content, rows: 4, class: "form-control", 
                  placeholder: "„Ç∑„Éß„ÉÉ„Éó„Å´„Å§„ÅÑ„Å¶„ÅÆ„Ç≥„É°„É≥„Éà„Çí„ÅäÊõ∏„Åç„Åè„Å†„Åï„ÅÑÔºàÊúÄÂ§ß500ÊñáÂ≠óÔºâ",
                  maxlength: 500, name: "comment[content]" %>
              <small class="character-count">0/500ÊñáÂ≠ó</small>
            </div>
            
            <!-- Èö†„Åó„Éï„Ç£„Éº„É´„Éâ„ÅßAPI„Éá„Éº„Çø„ÅÆÊÉÖÂ†±„Çí‰øùÊåÅ -->
            <%= f.hidden_field :place_id, value: @place_id, name: "comment[place_id]" %>
            <%= f.hidden_field :shop_name, value: @shop_name, name: "comment[shop_name]" %>
            <%= f.hidden_field :shop_address, value: @shop_address, name: "comment[shop_address]" %>
            
            <div class="form-actions">
              <%= f.submit "ÊäïÁ®ø„Åô„Çã", class: "btn btn-primary submit-review" %>
            </div>
          <% end %>
        <% else %>
          <!-- „Éá„Éº„Çø„Éô„Éº„Çπ„Éá„Éº„ÇøÁî®„ÅÆ„Ç≥„É°„É≥„Éà„Éï„Ç©„Éº„É† -->
          <%= form_with model: [@shop, @shop_comment], local: true do |f| %>
            <% if @shop_comment&.errors&.any? %>
              <div class="error-messages">
                <h4><%= pluralize(@shop_comment.errors.count, "‰ª∂„ÅÆ„Ç®„É©„Éº") %>„Åå„ÅÇ„Çä„Åæ„Åô:</h4>
                <ul>
                  <% @shop_comment.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>
            
            <div class="form-group">
              <%= f.label :rating, "Ë©ï‰æ°", class: "form-label" %>
              <%= f.select :rating, options_for_select((1..5).map{ |i| ["‚òÖ" * i + " (#{i})", i] }), 
                  { prompt: "Ë©ï‰æ°„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ" }, 
                  { class: "form-control rating-select" } %>
            </div>
            
            <div class="form-group">
              <%= f.label :content, "„Ç≥„É°„É≥„Éà", class: "form-label" %>
              <%= f.text_area :content, rows: 4, class: "form-control", 
                  placeholder: "„Ç∑„Éß„ÉÉ„Éó„Å´„Å§„ÅÑ„Å¶„ÅÆ„Ç≥„É°„É≥„Éà„Çí„ÅäÊõ∏„Åç„Åè„Å†„Åï„ÅÑÔºàÊúÄÂ§ß500ÊñáÂ≠óÔºâ",
                  maxlength: 500 %>
              <small class="character-count">0/500ÊñáÂ≠ó</small>
            </div>
            
            <div class="form-actions">
              <%= f.submit "ÊäïÁ®ø„Åô„Çã", class: "btn btn-primary submit-review" %>
            </div>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="login-prompt">
        <p>„É¨„Éì„É•„Éº„ÇíÊäïÁ®ø„Åô„Çã„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ</p>
        <%= link_to "„É≠„Ç∞„Ç§„É≥", new_user_session_path, class: "btn btn-outline-primary" %>
      </div>
    <% end %>

    <!-- AIÂàÜÊûê„Å´„Çà„ÇãË©ï‰æ°„Åæ„Å®„ÇÅ -->
    <% if @is_api_data %>
      <div class="ai-analysis-section">
        <h2>ü§ñ AIÂàÜÊûê„Å´„Çà„ÇãË©ï‰æ°„Åæ„Å®„ÇÅ</h2>
        <div class="ai-analysis-content">
          <% if @ai_review_summary.present? %>
            <div class="ai-summary">
              <%= render_markdown(@ai_review_summary) %>
            </div>
            <div class="ai-source">
              <small>‚Äª „Åì„ÅÆÂàÜÊûê„ÅØDeepSeek AI„ÅåGoogle Places„ÅÆ„É¨„Éì„É•„Éº„ÇíÂü∫„Å´Ëá™ÂãïÁîüÊàê„Åó„Åü„ÇÇ„ÅÆ„Åß„Åô</small>
            </div>
          <% else %>
            <div class="ai-analyze-action">
              <button id="analyzeBtn" class="btn btn-primary" onclick="startAIAnalysis()">
                ü§ñ AIÂàÜÊûê„ÇíÂÆüË°å
              </button>
              <div id="analyzeStatus" class="analyze-status" style="display: none;">
                ÂàÜÊûê‰∏≠... „Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ
              </div>
            </div>
            <div class="ai-hint">
              <p>üí° „Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®„ÄÅGoogle Places„ÅÆ„É¨„Éì„É•„Éº„ÇíÂü∫„Å´AI„ÅåÂ∫óËàó„ÅÆË©ï‰æ°„ÇíÂàÜÊûê„Åó„Åæ„Åô</p>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- HotpepperÊÉÖÂ†± -->
    
    
    <% if @hotpepper_shops && @hotpepper_shops.any? %>
      <div class="hotpepper-section">
        <h2>üçú Hotpepper „Ç∞„É´„É°ÊÉÖÂ†±</h2>
        <% if @hotpepper_fallback_search %>
          <div class="hotpepper-fallback-notice">
            <small>‚Äª Áõ¥Êé•„ÅÆÂ∫óËàóÂêç„Åß„ÅØË¶ã„Å§„Åã„Çâ„Å™„Åã„Å£„Åü„Åü„ÇÅ„ÄÅÈñ¢ÈÄ£„Åô„ÇãÂ∫óËàó„ÇíË°®Á§∫„Åó„Å¶„ÅÑ„Åæ„Åô</small>
          </div>
        <% end %>
        <div class="hotpepper-shops">
          <% @hotpepper_shops.first(3).each do |shop| %>
            <div class="hotpepper-shop-card">
              <div class="hotpepper-shop-header">
                <h3><%= shop['name'] %></h3>
                <% if shop['genre']['name'] %>
                  <span class="hotpepper-genre"><%= shop['genre']['name'] %></span>
                <% end %>
              </div>
              
              <div class="hotpepper-shop-info">
                <% if shop['catch'] %>
                  <p class="hotpepper-catch"><%= shop['catch'] %></p>
                <% end %>
                
                <% if shop['address'] %>
                  <div class="hotpepper-address">
                    <strong>‰ΩèÊâÄ:</strong> <%= shop['address'] %>
                  </div>
                <% end %>
                
                <% if shop['open'] %>
                  <div class="hotpepper-hours">
                    <strong>Âñ∂Ê•≠ÊôÇÈñì:</strong> <%= shop['open'] %>
                  </div>
                <% end %>
                
                
                
                <% if shop['access'] %>
                  <div class="hotpepper-access">
                    <strong>„Ç¢„ÇØ„Çª„Çπ:</strong> <%= shop['access'] %>
                  </div>
                <% end %>
              </div>
              
              <div class="hotpepper-shop-actions">
                <% if shop['urls']['pc'] %>
                  <a href="<%= shop['urls']['pc'] %>" target="_blank" class="btn btn-hotpepper">
                    Hotpepper„ÅßË©≥Á¥∞„ÇíË¶ã„Çã
                  </a>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
        
        <div class="hotpepper-source">
          <small>„Éá„Éº„ÇøÊèê‰æõ: <a href="https://webservice.recruit.co.jp/" target="_blank">„Éõ„ÉÉ„Éà„Éö„ÉÉ„Éë„Éº„Ç∞„É´„É° Web„Çµ„Éº„Éì„Çπ</a></small>
        </div>
      </div>
    <% elsif @hotpepper_shops.nil? %>
      <div class="hotpepper-section">
        <h2>üçú Hotpepper „Ç∞„É´„É°ÊÉÖÂ†±</h2>
        <div class="hotpepper-error">
          <p>Hotpepper„Åã„Çâ„ÅÆÊÉÖÂ†±„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</p>
          <small>API„Ç≠„Éº„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</small>
        </div>
      </div>
    <% elsif @hotpepper_shops.empty? %>
      <div class="hotpepper-section">
        <h2>üçú Hotpepper „Ç∞„É´„É°ÊÉÖÂ†±</h2>
        <div class="hotpepper-no-results">
          <p>„Äå<%= @shop_name || @shop&.name %>„Äç„Å´Èñ¢„Åô„ÇãÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</p>
          <small>Âà•„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„ÅßÊ§úÁ¥¢„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</small>
        </div>
      </div>
    <% end %>

    <!-- „É¨„Éì„É•„Éº‰∏ÄË¶ß -->
    <div class="reviews-section">
      <h2>„É¨„Éì„É•„Éº‰∏ÄË¶ß</h2>
      
      <% if @is_api_data %>
        <!-- „É¶„Éº„Ç∂„Éº„Ç≥„É°„É≥„Éà -->
        <% if @external_comments && @external_comments.any? %>
          <div class="user-comments">
            <h3>„É¶„Éº„Ç∂„Éº„É¨„Éì„É•„Éº</h3>
            <div class="comments-list">
              <% @external_comments.each do |comment| %>
                <div class="comment-item">
                  <div class="comment-header">
                    <div class="comment-user-info">
                      <span class="comment-user"><%= comment.user.name || "ÂåøÂêç„É¶„Éº„Ç∂„Éº" %></span>
                      <span class="comment-rating">
                        <% comment.rating.times do %>‚òÖ<% end %>
                        <span class="rating-number">(<%= comment.rating %>)</span>
                      </span>
                    </div>
                    <div class="comment-meta">
                      <span class="comment-date"><%= comment.created_at.strftime("%YÂπ¥%mÊúà%dÊó•") %></span>
                      <% if current_user == comment.user %>
                        <%= link_to "ÂâäÈô§", external_comment_path(comment), method: :delete, 
                            confirm: "Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü", 
                            class: "comment-delete" %>
                      <% end %>
                    </div>
                  </div>
                  <div class="comment-content">
                    <%= simple_format(comment.content) %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
        
        <!-- Google Places „É¨„Éì„É•„Éº -->
        <% if @place_reviews && @place_reviews.any? %>
          <div class="google-reviews">
            <h3>Google Places „É¨„Éì„É•„Éº</h3>
            <div class="reviews-list">
              <% @place_reviews.each do |review| %>
                <div class="review-item google-review">
                  <div class="review-header">
                    <div class="review-user-info">
                      <span class="review-author">
                        <% if review['author_name'] %>
                          <%= review['author_name'] %>
                        <% else %>
                          ÂåøÂêç„É¶„Éº„Ç∂„Éº
                        <% end %>
                      </span>
                      <div class="review-rating">
                        <% if review['rating'] %>
                          <% review['rating'].to_i.times do %>‚òÖ<% end %>
                          <% (5 - review['rating'].to_i).times do %>‚òÜ<% end %>
                          <span class="rating-number">(<%= review['rating'] %>)</span>
                        <% end %>
                      </div>
                    </div>
                    <div class="review-meta">
                      <span class="review-date">
                        <% if review['time'] %>
                          <%= Time.at(review['time']).strftime("%YÂπ¥%mÊúà%dÊó•") %>
                        <% end %>
                      </span>
                    </div>
                  </div>
                  <div class="review-content">
                    <% if review['text'] %>
                      <p><%= review['text'] %></p>
                    <% else %>
                      <p class="no-text">„É¨„Éì„É•„Éº„ÉÜ„Ç≠„Çπ„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                    <% end %>
                  </div>
                  <% if review['author_url'] %>
                    <div class="review-source">
                      <small>Google Places „ÅßÁ¢∫Ë™ç</small>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% elsif @external_comments.blank? %>
          <div class="no-reviews">
            <div class="no-reviews-icon">üí¨</div>
            <p>„É¨„Éì„É•„Éº„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
          </div>
        <% end %>
      <% else %>
        <!-- „Éá„Éº„Çø„Éô„Éº„Çπ„ÅÆ„Ç≥„É°„É≥„Éà -->
        <% if @shop.shop_comments.any? %>
          <div class="comments-list">
            <% @shop.shop_comments.order(created_at: :desc).each do |comment| %>
              <div class="comment-item">
                <div class="comment-header">
                  <div class="comment-user-info">
                    <span class="comment-user"><%= comment.user.name || "ÂåøÂêç„É¶„Éº„Ç∂„Éº" %></span>
                    <span class="comment-rating">
                      <% comment.rating.times do %>‚òÖ<% end %>
                      <span class="rating-number">(<%= comment.rating %>)</span>
                    </span>
                  </div>
                  <div class="comment-meta">
                    <span class="comment-date"><%= comment.created_at.strftime("%YÂπ¥%mÊúà%dÊó•") %></span>
                    <% if current_user == comment.user %>
                      <%= link_to "ÂâäÈô§", [@shop, comment], method: :delete, 
                          confirm: "Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü", 
                          class: "comment-delete" %>
                    <% end %>
                  </div>
                </div>
                <div class="comment-content">
                  <%= simple_format(comment.content) %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="no-comments">
            <div class="no-comments-icon">üí¨</div>
            <p>„Åæ„Å†„É¨„Éì„É•„Éº„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
            <p>ÊúÄÂàù„ÅÆ„É¨„Éì„É•„Éº„ÇíÊäïÁ®ø„Åó„Å¶„Åø„Åæ„Åõ„Çì„ÅãÔºü</p>
          </div>
        <% end %>
      <% end %>
    </div>
    
    <div class="shop-actions">
      <% if @search_query.present? %>
        <%= link_to "‰∏ÄË¶ß„Å´Êàª„Çã", shops_path(search: @search_query), class: "btn btn-secondary" %>
      <% else %>
        <%= link_to "‰∏ÄË¶ß„Å´Êàª„Çã", shops_path, class: "btn btn-secondary" %>
      <% end %>
    </div>
  </div>
<% end %>

<script>
// „Éï„Ç©„Éà„É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£„ÅÆÂ§âÊï∞
let currentPhotoIndex = 0;
let photos = [];

// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÂÜôÁúü„Éá„Éº„Çø„ÇíÊ∫ñÂÇô
document.addEventListener('DOMContentLoaded', function() {
  <% if @photos && @photos.any? %>
    photos = [
      <% @photos.first(12).each do |photo| %>
        {
          ref: '<%= photo['photo_reference'] %>',
          width: <%= photo['width'] || 800 %>,
          height: <%= photo['height'] || 600 %>
        },
      <% end %>
    ];
  <% end %>
});

function openPhotoModal(index) {
  currentPhotoIndex = index;
  const modal = document.getElementById('photoModal');
  const modalPhoto = document.getElementById('modalPhoto');
  const photoCounter = document.getElementById('photoCounter');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  
  if (photos.length === 0) return;
  
  // ÂÜôÁúü„ÇíË°®Á§∫
  updateModalPhoto();
  
  // „Ç´„Ç¶„É≥„Çø„Éº„ÇíÊõ¥Êñ∞
  photoCounter.textContent = `${currentPhotoIndex + 1} / ${photos.length}`;
  
  // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
  prevBtn.disabled = currentPhotoIndex === 0;
  nextBtn.disabled = currentPhotoIndex === photos.length - 1;
  
  // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
  modal.style.display = 'block';
  document.body.style.overflow = 'hidden'; // „Çπ„ÇØ„É≠„Éº„É´„ÇíÁÑ°ÂäπÂåñ
}

function closePhotoModal() {
  const modal = document.getElementById('photoModal');
  modal.style.display = 'none';
  document.body.style.overflow = ''; // „Çπ„ÇØ„É≠„Éº„É´„ÇíÊúâÂäπÂåñ
}

function changePhoto(direction) {
  const newIndex = currentPhotoIndex + direction;
  
  if (newIndex >= 0 && newIndex < photos.length) {
    currentPhotoIndex = newIndex;
    updateModalPhoto();
    
    // „Ç´„Ç¶„É≥„Çø„Éº„ÇíÊõ¥Êñ∞
    const photoCounter = document.getElementById('photoCounter');
    photoCounter.textContent = `${currentPhotoIndex + 1} / ${photos.length}`;
    
    // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    prevBtn.disabled = currentPhotoIndex === 0;
    nextBtn.disabled = currentPhotoIndex === photos.length - 1;
  }
}

function updateModalPhoto() {
  const modalPhoto = document.getElementById('modalPhoto');
  const photo = photos[currentPhotoIndex];
  
  if (photo) {
    // È´òËß£ÂÉèÂ∫¶„ÅÆÂÜôÁúü„ÇíÂèñÂæóÔºàmaxwidth=1200Ôºâ
    const photoUrl = `https://maps.googleapis.com/maps/api/place/photo?maxwidth=1200&photoreference=${photo.ref}&key=<%= ENV['GOOGLE_PLACES_API_KEY'] %>`;
    modalPhoto.src = photoUrl;
    modalPhoto.alt = '<%= @shop_name %> „ÅÆÂÜôÁúü';
  }
}

// „Ç≠„Éº„Éú„Éº„Éâ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
document.addEventListener('keydown', function(e) {
  const modal = document.getElementById('photoModal');
  if (modal.style.display === 'block') {
    if (e.key === 'Escape') {
      closePhotoModal();
    } else if (e.key === 'ArrowLeft') {
      changePhoto(-1);
    } else if (e.key === 'ArrowRight') {
      changePhoto(1);
    }
  }
});

// „É¢„Éº„ÉÄ„É´Â§ñ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Èñâ„Åò„Çã
document.getElementById('photoModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closePhotoModal();
  }
});

function startAIAnalysis() {
  const button = document.getElementById('analyzeBtn');
  const status = document.getElementById('analyzeStatus');
  const aiContent = document.querySelector('.ai-analysis-content');
  
  // „Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ„Åó„ÄÅÈÄ≤Ë°åÁä∂Ê≥Å„ÇíË°®Á§∫
  button.disabled = true;
  button.textContent = 'ÂàÜÊûê‰∏≠...';
  status.style.display = 'block';
  
  // „É™„ÇØ„Ç®„Çπ„Éà„Éë„É©„É°„Éº„Çø„ÇíÊ∫ñÂÇô
  const params = new URLSearchParams();
  params.append('place_id', '<%= @place_id %>');
  params.append('name', '<%= @shop_name %>');
  params.append('address', '<%= @shop_address %>');
  
  // AJAX„ÅßAIÂàÜÊûê„ÇíÂÆüË°å
  fetch('<%= analyze_ai_shop_path(id: params[:id]) %>', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
    },
    body: params
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // ÊàêÂäüÊôÇÔºöÂàÜÊûêÁµêÊûú„ÇíË°®Á§∫Ôºà„Çµ„Éº„Éê„ÉºÂÅ¥„ÅßMarkdown‚ÜíHTMLÂ§âÊèõÊ∏à„ÅøÔºâ
      aiContent.innerHTML = `
        <div class="ai-summary">${data.summary_html}</div>
        <div class="ai-source">
          <small>‚Äª „Åì„ÅÆÂàÜÊûê„ÅØDeepSeek AI„ÅåGoogle Places„ÅÆ„É¨„Éì„É•„Éº„ÇíÂü∫„Å´Ëá™ÂãïÁîüÊàê„Åó„Åü„ÇÇ„ÅÆ„Åß„Åô</small>
        </div>
      `;
    } else {
      // „Ç®„É©„ÉºÊôÇÔºö„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
      aiContent.innerHTML = `
        <div class="ai-error">
          <p>‚ö†Ô∏è AIÂàÜÊûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>
          <p>${data.error}</p>
        </div>
      `;
    }
  })
  .catch(error => {
    // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„ÉºÊôÇ
    aiContent.innerHTML = `
      <div class="ai-error">
        <p>‚ö†Ô∏è „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</p>
        <p>„Åó„Å∞„Çâ„ÅèÊôÇÈñì„Çí„Åä„ÅÑ„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
      </div>
    `;
  })
  .finally(() => {
    // „Éú„Çø„É≥„ÇíÂÖÉ„Å´Êàª„Åô
    button.disabled = false;
    button.textContent = 'ü§ñ AIÂàÜÊûê„ÇíÂÆüË°å';
    status.style.display = 'none';
  });
}
</script>

